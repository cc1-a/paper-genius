{% extends "base.html" %}

<!-- 1. DYNAMIC SEO DATA -->
{% block title %}{{ item.name }} | Edexcel Past Paper Book Sri Lanka | Paper Genius{% endblock %}
{% block description %}Get the printed {{ item.name }} past paper book (2019-2024). Customized covers and high-quality spiral binding. Island-wide delivery in Sri Lanka.{% endblock %}

{% block head %}
<!-- 2. OPEN GRAPH -->
<meta property="og:title" content="{{ item.name }} - Premium Past Paper Books">
<meta property="og:description" content="Order your custom {{ item.name }} resource. Fast delivery in Sri Lanka.">
<meta property="og:image" content="{{ item.img if item.img.startswith('http') else url_for('static', filename=item.img, _external=True) }}">

<style>
    .product-container { display: flex; gap: 30px; margin-top: 20px; align-items: flex-start; }
    .product-visual { flex: 1.2; position: sticky; top: 100px; display: flex; justify-content: center; }
    .magnify-container {
        width: 100%; max-width: 500px; max-height: 80vh; aspect-ratio: 1 / 1.414; 
        background: #fff; border: 2px solid var(--accent); overflow: hidden; position: relative; cursor: crosshair;
    }
    .magnify-container img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.1s ease-out; transform-origin: center center; }
    .product-info { flex: 1; min-width: 320px; }
    
    /* PRICE BOX STYLE */
    .price-display {
        background: rgba(var(--accent-rgb), 0.05); 
        border: 2px solid var(--accent); 
        padding: 15px; 
        text-align: center; 
        margin-top: 20px;
        margin-bottom: 20px;
        border-radius: 5px;
    }

    @media (max-width: 992px) {
        .product-container { flex-direction: column; align-items: center; }
        .product-visual { position: static; width: 100%; }
        .magnify-container { max-height: 60vh; }
    }
</style>
{% endblock %}

{% block body %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <a href="/Shop" class="mech-item text-decoration-none" style="font-size: 0.9rem;">
            <i class="fas fa-chevron-left me-2"></i> RETURN TO ARMORY
        </a>
    </nav>

    <div class="product-container">
        <!-- IMAGE SECTION -->
        <div class="product-visual">
            <div class="magnify-container" id="zoom-box">
                {% if item.img.startswith('http') %}
                    <img src="{{ item.img }}" id="main-img" alt="{{ item.name }} Edexcel Past Paper Book">
                {% else %}
                    <img src="{{ url_for('static', filename=item.img)}}" id="main-img" alt="{{ item.name }} Edexcel Past Paper Book">
                {% endif %}
            </div>
        </div>

        <!-- DETAILS SECTION -->
        <div class="product-info">
            <div class="mech-panel" style="padding: 30px;">
                <span class="badge bg-success mb-2" style="letter-spacing: 2px;">AUTHENTIC RESOURCE</span>
                <h1 class="display-5 fw-bold" style="font-family: 'Rajdhani';">{{ item.name }}</h1>
                
                <form action="/Shop" method="POST">
                    <input name="item_id" type="text" value="{{item.id}}" hidden>
                    
                    <div class="mb-3">
                        <label class="mech-label">COVER SPECIFICATION</label>
                        <select name="cover_type" id="cover-select" class="mech-input" required>
                            <!-- Cleaned up labels as requested -->
                            <option value="Normal">Normal Cover</option>
                            <option value="Custom">Custom Design</option>
                            <option value="Minimalistic">Minimalistic (Clear)</option>
                        </select>
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="mech-label">START YEAR</label>
                            <select name="selected_year_from" id="from-select" class="mech-input" required>
                                {% for year in item.years_available.keys()|sort %}
                                    <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="mech-label">END YEAR</label>
                            <select name="selected_year_to" id="to-select" class="mech-input" required>
                                {% for year in item.years_available.keys()|sort %}
                                    <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- DYNAMIC PRICE DISPLAY -->
                    <div class="price-display">
                        <h6 class="text-muted mb-1" style="font-family: 'Rajdhani'; letter-spacing: 1px;">ESTIMATED TOTAL</h6>
                        <h2 class="mb-0 fw-bold text-success" style="font-family: 'Rajdhani';">
                            LKR <span id="dynamic-price">...</span>
                        </h2>
                    </div>

                    <button type="submit" class="mech-action-btn w-100 py-3">
                        <i class="fas fa-cart-plus me-2"></i> ADD TO LOADOUT
                    </button>
                </form>

                <div class="mt-4">
                    <h5 class="fw-bold text-uppercase" style="font-family: 'Rajdhani'; color: var(--accent);">System Overview</h5>
                    <ul class="list-unstyled text-secondary small">
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> Comprehensive Edexcel Past Papers</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> High-resolution Laser Printing</li>
                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i> Durable Spiral Binding for 360Â° Use</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. DATA FROM FLASK (Page Counts) ---
    // This injects the database dictionary directly into JS code
    const yearsData = {{ item.years_available | tojson }};
    // Get keys sorted alphabetically to match the HTML select order (Start/End years)
    const sortedYears = Object.keys(yearsData).sort();

    // --- 2. ELEMENTS ---
    const coverSelect = document.getElementById('cover-select');
    const fromSelect = document.getElementById('from-select');
    const toSelect = document.getElementById('to-select');
    const priceDisplay = document.getElementById('dynamic-price');

    // --- 3. PRICING LOGIC ---
    function updatePrice() {
        // A. Prevent Invalid Dates
        const startIndex = fromSelect.selectedIndex;
        const endIndex = toSelect.selectedIndex;

        // Loop through End Year options to disable past dates
        for (let i = 0; i < toSelect.options.length; i++) {
            if (i < startIndex) {
                toSelect.options[i].disabled = true;
                toSelect.options[i].style.color = '#ccc';
            } else {
                toSelect.options[i].disabled = false;
                toSelect.options[i].style.color = 'var(--text-primary)';
            }
        }

        // Auto-correct End Year if it's before Start Year
        if (toSelect.selectedIndex < startIndex) {
            toSelect.selectedIndex = startIndex;
        }

        // B. Calculate Price
        // 1. Calculate Total Pages based on selected range
        let totalPages = 0;
        // Loop from Start Index to End Index (inclusive) using the sorted keys
        for (let i = startIndex; i <= toSelect.selectedIndex; i++) {
            let yearKey = sortedYears[i];
            // Add pages for this year (default to 0 if missing)
            totalPages += (yearsData[yearKey] || 0);
        }

        // 2. Determine Cover Cost
        const coverType = coverSelect.value;
        let coverCost = 200; // Normal
        if (coverType === 'Custom') coverCost = 500;
        if (coverType === 'Minimalistic') coverCost = 80;

        // 3. Formula: (Pages * 5) + 400 Binding + Cover
        const finalPrice = (totalPages * 5.0) + 400.0 + coverCost;

        // C. Update UI
        priceDisplay.innerText = finalPrice.toFixed(2);
    }

    // --- 4. EVENT LISTENERS ---
    fromSelect.addEventListener('change', updatePrice);
    toSelect.addEventListener('change', updatePrice);
    coverSelect.addEventListener('change', updatePrice);

    // --- 5. ZOOM LOGIC ---
    const zoomBox = document.getElementById('zoom-box');
    const mainImg = document.getElementById('main-img');

    zoomBox.addEventListener('mousemove', (e) => {
        const { left, top, width, height } = zoomBox.getBoundingClientRect();
        const x = ((e.clientX - left) / width) * 100;
        const y = ((e.clientY - top) / height) * 100;
        mainImg.style.transformOrigin = `${x}% ${y}%`;
        mainImg.style.transform = "scale(2.5)";
    });

    zoomBox.addEventListener('mouseleave', () => {
        mainImg.style.transform = "scale(1)";
        mainImg.style.transformOrigin = "center center";
    });

    // Run once on load
    updatePrice();
</script>
{% endblock %}
